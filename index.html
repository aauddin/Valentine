<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Valentine Quest</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; background:#0b0f1a; display:grid; place-items:center; height:100vh; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { width:min(960px, 96vw); }
    canvas { width:100%; image-rendering: pixelated; border-radius:14px; box-shadow: 0 20px 60px rgba(0,0,0,.45); background:#0b0f1a; }
    .hud { display:flex; gap:10px; justify-content:space-between; align-items:center; margin:10px 2px 0; opacity:.9; font-size:14px; }
    .kbd { border:1px solid rgba(255,255,255,.18); padding:2px 8px; border-radius:8px; }
  </style>
</head>
<body>
<div class="wrap">
  <canvas id="c" width="480" height="270"></canvas>

  <!-- üéµ Music Added -->
  <audio id="bgm" src="/music.mp3" loop preload="auto"></audio>

  <div class="hud">
    <div>
      <span class="kbd">A</span><span class="kbd">D</span> / <span class="kbd">‚Üê</span><span class="kbd">‚Üí</span> move
      &nbsp; <span class="kbd">Space</span> jump
      &nbsp; <span class="kbd">E</span> interact
    </div>
    <div id="status">Loading love‚Ä¶</div>
  </div>
</div>

<script>
(() => {

  const GIRLFRIEND_NAME = "Araya";
  const YOUR_NAME = "Bruce";
  const FINAL_LINE = `Happy Valentine's Day, ${GIRLFRIEND_NAME}. I choose you ‚Äî always.`;
  const SUB_LINE   = `‚Äî ${YOUR_NAME}`;

  const MEMORIES = [
    "Memory #1: The moment I realized you felt like home.",
    "Memory #2: Our inside jokes that still make me grin.",
    "Memory #3: The future I keep building in my head‚Ä¶ with you in it."
  ];

  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;
  const statusEl = document.getElementById("status");

  // üéµ Music Setup (10%)
  const bgm = document.getElementById("bgm");
  window.addEventListener("keydown", () => {
    if (bgm.paused) {
      bgm.volume = 0.10;
      bgm.play().catch(()=>{});
    }
  }, { once:true });

  const keys = new Set();
  let justPressedE = false;

  window.addEventListener("keydown", (e) => {
    if (["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"," "].includes(e.key)) e.preventDefault();
    keys.add(e.key.toLowerCase());
    if (e.key.toLowerCase() === "e") justPressedE = true;
  }, { passive:false });

  window.addEventListener("keyup", (e) => keys.delete(e.key.toLowerCase()));

  const TS = 16;
  const W = 30, H = 17;

  const map = [
    "000000000000000000000000000000",
    "000000000000000000000000000000",
    "000000000000000000000000000000",
    "000000000000000000000000003000",
    "000000000000000000000000011100",
    "000000000000000200000000000000",
    "000000000000011110000000000000",
    "000000000000000000000003000000",
    "000000000111100000000111100000",
    "000000000000000000000000000000",
    "000000030000000000200000000000",
    "000011110000000001111000000400",
    "000000000000000000000000001111",
    "000000000000000000000000000000",
    "000000000000000000000000000000",
    "011111111111111111111111111110",
    "111111111111111111111111111111",
  ].map(row => row.split("").map(Number));

  const collectibles = [];
  for (let y=0; y<H; y++)
    for (let x=0; x<W; x++)
      if (map[y][x] === 3)
        collectibles.push({ x, y, taken:false, id: collectibles.length });

  let gate = { x:-1, y:-1, open:false };
  for (let y=0; y<H; y++)
    for (let x=0; x<W; x++)
      if (map[y][x] === 4)
        gate = { x, y, open:false };

  const player = {
    x: 2*TS, y: 12*TS,
    w: 12, h: 14,
    vx: 0, vy: 0,
    onGround: false
  };

  const physics = { grav:900, move:220, jump:360, friction:0.85 };
  const cam = { x:0, y:0 };

  let bubble = { text:"", t:0, show:false };
  function showBubble(text, seconds=2.6){
    bubble.text = text;
    bubble.t = seconds;
    bubble.show = true;
  }

  function isSolid(t){ return t===1; }

  function aabb(ax, ay, aw, ah, bx, by, bw, bh){
    return ax < bx+bw && ax+aw > bx && ay < by+bh && ay+ah > by;
  }

  function clear(){
    ctx.fillStyle = "#0b0f1a";
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  function drawTile(x,y,t){
    const px = x*TS - cam.x;
    const py = y*TS - cam.y;

    if (t===1){
      ctx.fillStyle = "#1b2a4a";
      ctx.fillRect(px, py, TS, TS);
    }
    else if (t===2){
      ctx.fillStyle = "#d8c49b";
      ctx.fillRect(px+4, py+2, 8, 6);
    }
    else if (t===4){
      // üö™ Wooden Door
      ctx.fillStyle = "#5a3e2b";
      ctx.fillRect(px+2, py+1, TS-4, TS-2);

      ctx.fillStyle = gate.open ? "#9de38f" : "#8b5a2b";
      ctx.fillRect(px+4, py+3, TS-8, TS-6);

      if (!gate.open){
        ctx.fillStyle = "#ffd700";
        ctx.fillRect(px+TS-8, py+TS/2, 2, 2);
      }
    }
  }

  function drawHeart(px, py, taken){
    if (taken) return;
    const hx = px - cam.x + 4;
    const hy = py - cam.y + 4;
    ctx.fillStyle = "#ff5c7a";
    const pixels = [
      "..xx.xx..",
      ".xxxxxxx.",
      "xxxxxxxxx",
      "xxxxxxxxx",
      ".xxxxxxx.",
      "..xxxxx..",
      "...xxx..."
    ];
    for (let y=0; y<pixels.length; y++)
      for (let x=0; x<pixels[y].length; x++)
        if (pixels[y][x] === "x")
          ctx.fillRect(hx + x, hy + y, 1, 1);
  }

  // üëë Minimalist Princess
  function drawPlayer(){
    const px = player.x - cam.x;
    const py = player.y - cam.y;

    // Dress
    ctx.fillStyle = "#ff8ad6";
    ctx.fillRect(px, py+4, player.w, player.h-4);

    // Head
    ctx.fillStyle = "#ffe0bd";
    ctx.fillRect(px+3, py-2, 6, 6);

    // Crown
    ctx.fillStyle = "#ffd700";
    ctx.fillRect(px+4, py-4, 4, 2);

    // Eyes
    ctx.fillStyle = "#000";
    ctx.fillRect(px+4, py, 1, 1);
    ctx.fillRect(px+7, py, 1, 1);
  }

  let heartsCollected = 0;
  let finished = false;

  function updateStatus(){
    statusEl.textContent = finished
      ? "Reunited üíû"
      : `Hearts: ${heartsCollected}/${collectibles.length}`;
  }

  function resolveCollisions(axis){
    const left = Math.floor(player.x / TS);
    const right = Math.floor((player.x + player.w) / TS);
    const top = Math.floor(player.y / TS);
    const bottom = Math.floor((player.y + player.h) / TS);

    player.onGround = false;

    for (let y=top; y<=bottom; y++){
      for (let x=left; x<=right; x++){
        const t = (x<0||y<0||x>=W||y>=H)?1:map[y][x];
        if (!isSolid(t)) continue;
        const tx = x*TS, ty = y*TS;

        if (aabb(player.x,player.y,player.w,player.h,tx,ty,TS,TS)){
          if (axis==="x"){
            if (player.vx>0) player.x=tx-player.w;
            else if (player.vx<0) player.x=tx+TS;
            player.vx=0;
          } else {
            if (player.vy>0){
              player.y=ty-player.h;
              player.vy=0;
              player.onGround=true;
            } else if (player.vy<0){
              player.y=ty+TS;
              player.vy=0;
            }
          }
        }
      }
    }
  }

  function step(dt){
    if (finished) return;

    const left  = keys.has("a") || keys.has("arrowleft");
    const right = keys.has("d") || keys.has("arrowright");
    const jump  = keys.has(" ");

    if (left) player.vx=-physics.move;
    if (right) player.vx=physics.move;
    if (!left && !right) player.vx*=physics.friction;

    if (jump && player.onGround){
      player.vy=-physics.jump;
      player.onGround=false;
    }

    player.vy+=physics.grav*dt;

    player.x+=player.vx*dt; resolveCollisions("x");
    player.y+=player.vy*dt; resolveCollisions("y");

    for (const h of collectibles){
      if (h.taken) continue;
      const px=h.x*TS, py=h.y*TS;
      if (aabb(player.x,player.y,player.w,player.h,px+3,py+3,TS-6,TS-6)){
        h.taken=true;
        heartsCollected++;
        if (heartsCollected>=collectibles.length){
          gate.open=true;
          showBubble(`The door opened. Come to me, ${GIRLFRIEND_NAME}.`,3);
        }
      }
    }

    if (gate.open){
      const gx=gate.x*TS, gy=gate.y*TS;
      if (aabb(player.x,player.y,player.w,player.h,gx,gy,TS,TS))
        finished=true;
    }

    updateStatus();
    justPressedE=false;
  }

  function draw(){
    clear();
    for (let y=0;y<H;y++)
      for (let x=0;x<W;x++){
        const t=map[y][x];
        if (t===0||t===3) continue;
        drawTile(x,y,t);
      }

    for (const h of collectibles)
      drawHeart(h.x*TS,h.y*TS,h.taken);

    drawPlayer();

    if (finished){
      ctx.fillStyle="rgba(0,0,0,.7)";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle="white";
      ctx.font="18px system-ui";
      ctx.fillText("REUNITED üíû",150,120);
    }
  }

  let last=performance.now();
  function loop(now){
    const dt=Math.min(0.033,(now-last)/1000);
    last=now;
    step(dt);
    draw();
    requestAnimationFrame(loop);
  }

  updateStatus();
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
