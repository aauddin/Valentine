<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Valentine Quest</title>

<style>
:root { color-scheme: dark; }
body { margin:0; background:#0b0f1a; display:grid; place-items:center; height:100vh; font-family:system-ui; }
.wrap { width:min(960px,96vw); }
canvas { width:100%; image-rendering:pixelated; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.45); background:#0b0f1a; }
.hud { display:flex; justify-content:space-between; margin-top:8px; font-size:14px; opacity:.9; }
.kbd { border:1px solid rgba(255,255,255,.18); padding:2px 8px; border-radius:8px; }
</style>
</head>
<body>
<div class="wrap">
<canvas id="c" width="480" height="270"></canvas>
<audio id="bgm" src="/music.mp3" loop preload="auto"></audio>

<div class="hud">
<div>
<span class="kbd">A</span><span class="kbd">D</span> /
<span class="kbd">‚Üê</span><span class="kbd">‚Üí</span>
move &nbsp;
<span class="kbd">Space</span> jump
</div>
<div id="status"></div>
</div>
</div>

<script>
(() => {

const GIRLFRIEND_NAME="Araya";
const YOUR_NAME="Bruce";
const FINAL_LINE=`Happy Valentine's Day, ${GIRLFRIEND_NAME}. I choose you ‚Äî always.`;
const SUB_LINE=`‚Äî ${YOUR_NAME}`;

const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
ctx.imageSmoothingEnabled=false;
const statusEl=document.getElementById("status");

const bgm=document.getElementById("bgm");
window.addEventListener("keydown",()=>{
 if(bgm.paused){
  bgm.volume=0.10;
  bgm.play().catch(()=>{});
 }
},{once:true});

const keys=new Set();
window.addEventListener("keydown",e=>{
 if(["ArrowLeft","ArrowRight"," "].includes(e.key)) e.preventDefault();
 keys.add(e.key.toLowerCase());
});
window.addEventListener("keyup",e=>keys.delete(e.key.toLowerCase()));

const TS=16,W=30,H=17;

const map=[
"000000000000000000000000000000",
"000000000000000000000000000000",
"000000000000000000000000003000",
"000000000000000000000000011100",
"000000000000000200000000000000",
"000000000000011110000000000000",
"000000000000000000000003000000",
"000000000111100000000111100000",
"000000000000000000000000000000",
"000000030000000000200000000000",
"000011110000000001111000000400",
"000000000000000000000000001111",
"000000000000000000000000000000",
"000000000000000000000000000000",
"011111111111111111111111111110",
"111111111111111111111111111111",
].map(r=>r.split("").map(Number));

let collectibles=[];
for(let y=0;y<H;y++)
 for(let x=0;x<W;x++)
  if(map[y][x]===3)
   collectibles.push({x,y,taken:false});

let gate={x:-1,y:-1,open:false};
for(let y=0;y<H;y++)
 for(let x=0;x<W;x++)
  if(map[y][x]===4)
   gate={x,y,open:false};

const player={
 x:2*TS,y:12*TS,
 w:14,h:16,
 vx:0,vy:0,
 onGround:false
};

const physics={grav:900,move:220,jump:360,friction:.85};
const cam={x:0,y:0};

let bubble={text:"",time:0};

function showBubble(text,seconds=3){
 bubble.text=text;
 bubble.time=seconds;
}

function isSolid(t){return t===1;}
function aabb(a,b,c,d,e,f,g,h){
 return a<e+g&&a+c>e&&b<f+h&&b+d>f;
}

function resolve(axis){
 const left=Math.floor(player.x/TS);
 const right=Math.floor((player.x+player.w)/TS);
 const top=Math.floor(player.y/TS);
 const bottom=Math.floor((player.y+player.h)/TS);

 player.onGround=false;

 for(let y=top;y<=bottom;y++){
  for(let x=left;x<=right;x++){
   const t=(x<0||y<0||x>=W||y>=H)?1:map[y][x];
   if(!isSolid(t)) continue;
   const tx=x*TS,ty=y*TS;

   if(aabb(player.x,player.y,player.w,player.h,tx,ty,TS,TS)){
    if(axis==="x"){
     if(player.vx>0) player.x=tx-player.w;
     else if(player.vx<0) player.x=tx+TS;
     player.vx=0;
    }else{
     if(player.vy>0){
      player.y=ty-player.h;
      player.vy=0;
      player.onGround=true;
     }else if(player.vy<0){
      player.y=ty+TS;
      player.vy=0;
     }
    }
   }
  }
 }
}

let heartsCollected=0;
let finished=false;

function step(dt){

 const left=keys.has("a")||keys.has("arrowleft");
 const right=keys.has("d")||keys.has("arrowright");
 const jump=keys.has(" ");

 if(left) player.vx=-physics.move;
 if(right) player.vx=physics.move;
 if(!left&&!right) player.vx*=physics.friction;

 if(jump&&player.onGround){
  player.vy=-physics.jump;
  player.onGround=false;
 }

 player.vy+=physics.grav*dt;

 player.x+=player.vx*dt; resolve("x");
 player.y+=player.vy*dt; resolve("y");

 for(const h of collectibles){
  if(h.taken) continue;
  const px=h.x*TS,py=h.y*TS;
  if(aabb(player.x,player.y,player.w,player.h,px+3,py+3,TS-6,TS-6)){
   h.taken=true;
   heartsCollected++;
   showBubble("A memory collected üíó");
   if(heartsCollected>=collectibles.length){
    gate.open=true;
    showBubble("The door opened.");
   }
  }
 }

 if(gate.open){
  const gx=gate.x*TS,gy=gate.y*TS;
  if(aabb(player.x,player.y,player.w,player.h,gx,gy,TS,TS))
   finished=true;
 }

 if(bubble.time>0) bubble.time-=dt;

 statusEl.textContent=finished?"Reunited üíû":`Hearts ${heartsCollected}/${collectibles.length}`;
}

function drawPrincess(px,py){

 // Hair (black semicircle)
 ctx.fillStyle="black";
 ctx.beginPath();
 ctx.arc(px+player.w/2,py-2,7,Math.PI,0);
 ctx.fill();

 // Head
 ctx.fillStyle="#ffe0bd";
 ctx.beginPath();
 ctx.arc(px+player.w/2,py,5,0,Math.PI*2);
 ctx.fill();

 // Crown
 ctx.fillStyle="#ffd700";
 ctx.fillRect(px+player.w/2-3,py-8,6,3);

 // Triangle dress
 ctx.fillStyle="#ff69b4";
 ctx.beginPath();
 ctx.moveTo(px+player.w/2,py+4);
 ctx.lineTo(px-2,py+player.h);
 ctx.lineTo(px+player.w+2,py+player.h);
 ctx.closePath();
 ctx.fill();
}

function drawTile(x,y,t){
 const px=x*TS,py=y*TS;

 if(t===1){
  ctx.fillStyle="#1b2a4a";
  ctx.fillRect(px,py,TS,TS);
 }
 if(t===4){
  ctx.fillStyle="#5a3e2b";
  ctx.fillRect(px+2,py+1,TS-4,TS-2);

  ctx.fillStyle=gate.open?"#9de38f":"#8b5a2b";
  ctx.fillRect(px+4,py+3,TS-8,TS-6);
 }
}

function draw(){
 ctx.fillStyle="#0b0f1a";
 ctx.fillRect(0,0,480,270);

 for(let y=0;y<H;y++)
  for(let x=0;x<W;x++)
   if(map[y][x]!==0&&map[y][x]!==3)
    drawTile(x,y,map[y][x]);

 for(const h of collectibles)
  if(!h.taken){
   ctx.fillStyle="#ff5c7a";
   ctx.fillRect(h.x*TS+6,h.y*TS+6,4,4);
  }

 drawPrincess(player.x,player.y);

 if(bubble.time>0){
  ctx.fillStyle="rgba(0,0,0,.6)";
  ctx.fillRect(10,10,460,40);
  ctx.fillStyle="white";
  ctx.font="14px system-ui";
  ctx.fillText(bubble.text,20,35);
 }

 if(finished){
  ctx.fillStyle="rgba(0,0,0,.75)";
  ctx.fillRect(0,0,480,270);
  ctx.fillStyle="white";
  ctx.font="18px system-ui";
  ctx.fillText("REUNITED üíû",150,120);
  ctx.font="14px system-ui";
  ctx.fillText(FINAL_LINE,60,150);
  ctx.fillText(SUB_LINE,200,175);
 }
}

let last=performance.now();
function loop(now){
 const dt=Math.min(.033,(now-last)/1000);
 last=now;
 step(dt);
 draw();
 requestAnimationFrame(loop);
}

showBubble(`Hi ${GIRLFRIEND_NAME} üíó Collect the hearts.`,3);
requestAnimationFrame(loop);

})();
</script>
</body>
</html>
